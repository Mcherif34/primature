package ma.brainit.aman.client.actions;

import ma.brainit.aman.administration.dto.SecUtilisateurDTO;
import ma.brainit.aman.administration.service.SecUtilisateurService;
import ma.brainit.aman.client.dto.CourrierClassiqueDTO;
import ma.brainit.aman.client.dto.DocumentDTO;
import ma.brainit.aman.client.service.CorrespondanceService;
import ma.brainit.aman.client.service.CourrierClassiqueService;
import ma.brainit.aman.client.service.WSubWorkTaskService;
import ma.brainit.base.utils.Util;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.ModelAndView;

import java.util.List;
import java.util.Optional;

import javax.servlet.http.HttpServletResponse;
import javax.xml.parsers.ParserConfigurationException;

@Controller
@RequestMapping(value = "/correspondances")
public class CorrespondanceController {

	private static final Logger log = LoggerFactory.getLogger(CorrespondanceController.class);
	
	@Autowired
	private CorrespondanceService CourrierClassiqueService;
	
	@Autowired
	private WSubWorkTaskService wSubWorkTaskService;
	
	@Autowired
	private SecUtilisateurService secUtilisateurService;
	
	@RequestMapping(value = { "", "/" }, method = RequestMethod.GET)
	public ModelAndView login(Model model, HttpServletResponse response) {
		ModelAndView modelAndView = new ModelAndView("client/correspondanceList");
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (!(auth instanceof AnonymousAuthenticationToken)) {
			
			SecUtilisateurDTO user = secUtilisateurService.getCurrentUser();
			modelAndView.addObject("name", user.getNom());
			modelAndView.addObject("profile", user.getSecProfileCode());
			
		} else {
			response.addHeader("REQUIRES_AUTH", "1");
			modelAndView.setViewName("home/login");
		}
		
		return modelAndView;
	}
	
	@RequestMapping(value="/rest/list", method=RequestMethod.GET)
	public @ResponseBody ResponseEntity<String> getCourrierClassiquePage(
			@RequestParam("page") Optional<Integer> page,
			@RequestParam("limit") Optional<Integer> limit,
			@RequestParam("sort") Optional<String> sort,
			@RequestParam("direction") Optional<String> direction,
			@RequestParam("search") Optional<String> search){
		String result = CourrierClassiqueService.getPage(page.orElse(0),limit.orElse(null),sort.orElse(null),direction.orElse(null),search.orElse(null));
		return new ResponseEntity<String>(result, HttpStatus.OK);
	}
	
	@RequestMapping(value="/rest/currentList", method=RequestMethod.GET)
	public @ResponseBody ResponseEntity<String> getCurrentCourrierClassiquePage(
			@RequestParam("page") Optional<Integer> page,
			@RequestParam("limit") Optional<Integer> limit,
			@RequestParam("sort") Optional<String> sort,
			@RequestParam("direction") Optional<String> direction,
			@RequestParam("search") Optional<String> search){
		String result = CourrierClassiqueService.getCurrentPage(page.orElse(0),limit.orElse(null),sort.orElse(null),direction.orElse(null),search.orElse(null));
		return new ResponseEntity<String>(result, HttpStatus.OK);
	}
	
	@RequestMapping(value="/rest/search/{refArriveeBoc}/{receptionDateStart}/{receptionDateEnd}/{refExpediteur}/{enregistrementDateStart}/{enregistrementDateEnd}/{expediteur}/{status}/{echeanceDateStart}/{echeanceDateEnd}/{typeCourrier}/{typeInstructionDg}/{objet}/{urgence}", method=RequestMethod.GET )
	public @ResponseBody ResponseEntity<String> advancedSearch(
			@RequestParam("page") Optional<Integer> page,
			@RequestParam("limit") Optional<Integer> limit,
			@RequestParam("sort") Optional<String> sort,
			@RequestParam("direction") Optional<String> direction,
			@RequestParam("search") Optional<String> search,
			@PathVariable("refArriveeBoc") String refArriveeBoc,
			@PathVariable("receptionDateStart") String receptionDateStart,
			@PathVariable("receptionDateEnd") String receptionDateEnd,
			@PathVariable("refExpediteur") String refExpediteur,
			@PathVariable("enregistrementDateStart") String enregistrementDateStart,
			@PathVariable("enregistrementDateEnd") String enregistrementDateEnd,
			@PathVariable("expediteur") String expediteur,
			@PathVariable("status") String status,
			@PathVariable("echeanceDateStart") String echeanceDateStart,
			@PathVariable("echeanceDateEnd") String echeanceDateEnd,
			@PathVariable("typeCourrier") String typeCourrier,
			@PathVariable("typeInstructionDg") String typeInstructionDg,
			@PathVariable("objet") String objet,
			@PathVariable("urgence") String urgence) {
		String result = CourrierClassiqueService.advancedSearch(page.orElse(0),limit.orElse(null),sort.orElse(null),direction.orElse(null),search.orElse(null), refArriveeBoc, receptionDateStart, receptionDateEnd, refExpediteur, enregistrementDateStart, enregistrementDateEnd, expediteur, status, echeanceDateStart, echeanceDateEnd, typeCourrier, typeInstructionDg, objet, urgence);
		return new ResponseEntity<String>(result, HttpStatus.OK);
	}
	
	@RequestMapping(value="/rest/taskList/{workId}", method=RequestMethod.GET)
	public @ResponseBody ResponseEntity<String> getTaskPage(
			@RequestParam("page") Optional<Integer> page,
			@RequestParam("limit") Optional<Integer> limit,
			@RequestParam("sort") Optional<String> sort,
			@RequestParam("direction") Optional<String> direction,
			@RequestParam("search") Optional<String> search,
			@PathVariable("workId") Long workId){
		String result = wSubWorkTaskService.getPage(page.orElse(0),limit.orElse(null),sort.orElse(null),direction.orElse(null),search.orElse(null), workId);
		return new ResponseEntity<String>(result, HttpStatus.OK);
	}
	
	@RequestMapping(value="/rest/load/{id}", method=RequestMethod.GET )
	public @ResponseBody String load(@PathVariable("id") Long id){
		CourrierClassiqueDTO dto =  CourrierClassiqueService.load(id);
		return Util.toJson(dto);
	}
	
	@RequestMapping(value="/rest/loadByReference/{reference}", method=RequestMethod.GET )
	public @ResponseBody String loadByReference(@PathVariable("reference") String reference){
		CourrierClassiqueDTO dto =  CourrierClassiqueService.loadByReference(reference);
		return Util.toJson(dto);
	}
	
	@RequestMapping(value="/rest/loadDocumentsByReference/{reference}", method=RequestMethod.GET )
	public @ResponseBody String loadDocumentsByReference(@PathVariable("reference") String reference){
		List<DocumentDTO> list =  CourrierClassiqueService.loadDocumentsByReference(reference);
		return Util.toJson(list);
	}
	
	@RequestMapping(value="/rest/save", method=RequestMethod.POST )
	public @ResponseBody String save(@RequestBody CourrierClassiqueDTO dto){
		CourrierClassiqueDTO returnedDTO = CourrierClassiqueService.save(dto);
		return Util.toJson(returnedDTO);
	}
	
	@RequestMapping(value="/rest/delete/{id}", method=RequestMethod.POST )
	public @ResponseBody String remove(@PathVariable("id") Long id){
		CourrierClassiqueService.delete(id);
		return Util.OK;
	}
	
	@RequestMapping(value="/rest/getAll", method=RequestMethod.GET)
	public @ResponseBody String getAll(){
		return Util.toJson(CourrierClassiqueService.getAll());
	}
	
	@RequestMapping(value="/rest/getCurrentRegularCount", method=RequestMethod.GET)
	public @ResponseBody String getCurrentClassiqueCount(){
		return Util.toJson(CourrierClassiqueService.getCurrentClassiqueCount());
	}
	
	@RequestMapping(value="/rest/getCurrentRegularCountByYear/{year}", method=RequestMethod.GET)
	public @ResponseBody String getCurrentClassiqueCountByYear(@PathVariable("year") int year){
		return Util.toJson(CourrierClassiqueService.getCurrentClassiqueCountByYear(year));
	}
	
	@RequestMapping(value="/rest/getCurrentNotOverdueRegularCount", method=RequestMethod.GET)
	public @ResponseBody String getCurrentNotOverdueInvoiceCount(){
		return Util.toJson(CourrierClassiqueService.getCurrentNotOverdueClassiqueCount());
	}
	
	@RequestMapping(value="/rest/getCurrentOverdueRegularCount", method=RequestMethod.GET)
	public @ResponseBody String getCurrentOverdueInvoiceCount(){
		return Util.toJson(CourrierClassiqueService.getCurrentOverdueClassiqueCount());
	}
	
	@RequestMapping(value="/rest/getCompletedRegularCount", method=RequestMethod.GET)
	public @ResponseBody String getCompletedClassiqueCount(){
		return Util.toJson(CourrierClassiqueService.getCompletedClassiqueCount());
	}
	
	@RequestMapping(value="/rest/getCompletedRegularCountByYear/{year}", method=RequestMethod.GET)
	public @ResponseBody String getCompletedClassiqueCountByYear(@PathVariable("year") int year){
		return Util.toJson(CourrierClassiqueService.getCompletedClassiqueCountByYear(year));
	}
	
	@RequestMapping(value="/rest/downloadAttachment/{dataId}", method=RequestMethod.GET)
	public void exportXMLDeclaration(HttpServletResponse response, @PathVariable("dataId") long dataId) throws ParserConfigurationException {
		CourrierClassiqueService.downloadAttachment(dataId, response);
	}
	
	@Transactional
	@CrossOrigin(origins = "*")
	@RequestMapping(value="/rest/getAllTask/{wWorkId}", method=RequestMethod.GET)
	public @ResponseBody String getAllTask(@PathVariable("wWorkId") Long wWorkId){
		return Util.toJson(wSubWorkTaskService.getAllByWork(wWorkId));
	}
	
}